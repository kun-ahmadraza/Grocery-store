{% extends "base.html" %}
{% block content %}

<section class="py-5">
    <div class="container">

        <h2 class="mb-4 fw-bold">Your Shopping Cart</h2>

        <div class="row g-4">

                    <!-- LEFT SIDE – CART ITEMS -->
                    <div class="col-lg-8">

            <div class="p-4 bg-white shadow-sm rounded-4 border">

                {% for item in cart %}
                <!-- CART ROW -->
                <div class="d-flex align-items-center pb-4 mb-4 border-bottom">

                    <!-- PRODUCT IMAGE -->
                    <figure class="me-3" style="width: 150px;">
                        {% if item.product.images %}
                        <img src="/{{ item.product.images[0].image_url }}"
                            class="img-fluid rounded" alt="">
                        {% else %}
                        <img src="/static/placeholder.png" class="img-fluid rounded" alt="">
                        {% endif %}
                    </figure>

                    <!-- PRODUCT DETAILS -->
                    <div class="flex-grow-1">
                        <h5 class="mb-1 fw-bold">{{ item.product.name }}</h5>
                        <p class="fw-bold mb-2">
                            PKR <span id="price-{{ item.cart_id }}">{{ item.product.price * item.quantity }}</span>
                        </p>
                        <div class="d-flex align-items-center mt-2">

                            <button class="btn btn-primary px-3 qty-btn" 
                                    data-id="{{ item.cart_id }}" 
                                    data-price="{{ item.product.price }}"
                                    data-action="decrease">-</button>

                            <input type="text" 
                                id="qty-{{ item.cart_id }}" 
                                value="{{ item.quantity }}" 
                                class="quantity-input form-control mx-2 text-center" 
                                style="width: 60px;" readonly>

                            <button class="btn btn-primary px-3 qty-btn" 
                                    data-id="{{ item.cart_id }}" 
                                    data-price="{{ item.product.price }}"
                                    data-action="increase">+</button>
                        </div>

                    </div>

                    <!-- PRICE + REMOVE BUTTON -->
                    <div class="text-end">
                        <p>{{ cart_count(request) }}</p>
                        <p class="fw-bold mb-2">PKR {{ item.product.price }}</p>
                        <form method="post" action="/cart/delete">
                            <input type="hidden" name="cart_id" value="{{ item.cart_id }}">
                            <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                        </form>
                    </div>

                </div>
                <!-- END CART ROW -->
                {% endfor %}

            </div>

        </div>


            <!-- RIGHT SIDE – SUMMARY BOX -->
            <div class="col-lg-4">
                <div class="p-4 bg-white shadow-sm rounded-4 border mb-4">
                    <h5 class="fw-bold mb-3">Order Summary</h5>

                    <div class="d-flex justify-content-between border-top pt-3 mt-3">
                        <span>Subtotal</span>
                        <strong class="fw-bold" id="cart-subtotal">PKR {{ total_price }}</strong>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping</span>
                        <span class="fw-bold text-success">Free</span>
                    </div>

                    <div class="d-flex justify-content-between border-top pt-3 mt-3">
                        <strong>Total</strong>
                        <strong class="fw-bold" id="cart-total">PKR {{ total_price }}</strong>
                    </div>


                    <a href="#" class="btn btn-primary w-100 mt-4 py-2">Proceed to Checkout</a>
                </div>

                <!-- COUPON BOX -->
                <div class="p-4 bg-white shadow-sm rounded-4 border">
                    <h6 class="fw-bold mb-3">Have a Coupon?</h6>

                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Enter coupon code">
                        <button class="btn btn-primary">Apply</button>
                    </div>
                </div>

            </div>

        </div>

    </div>
</section>
<script>
// ----- Increase / Decrease + Update -----
document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', async () => {

        const cartId = btn.dataset.id;
        const action = btn.dataset.action;
        const unitPrice = parseFloat(btn.dataset.price);

        const response = await fetch(`/update_quantity/${cartId}?action=${action}`, {
            method: "POST"
        });

        const data = await response.json();

        if (data.success) {
            const newQty = data.new_quantity;

            // Update quantity field
            document.getElementById(`qty-${cartId}`).value = newQty;

            // Update item subtotal
            const newItemPrice = (unitPrice * newQty).toFixed(2);
            document.getElementById(`price-${cartId}`).textContent = newItemPrice;

            // Update grand total
            updateCartTotal();
        }
    });
});

// ----- Function to update total -----
function updateCartTotal() {
    let total = 0;

    document.querySelectorAll('[id^="price-"]').forEach(priceEl => {
        total += parseFloat(priceEl.textContent);
    });

    // Update Subtotal
    document.getElementById("cart-subtotal").textContent = total.toFixed(2);

    // Update Total (with PKR text)
    document.getElementById("cart-total").textContent = "PKR " + total.toFixed(2);
}

// Run on page load
updateCartTotal();

</script>


{% endblock %}
